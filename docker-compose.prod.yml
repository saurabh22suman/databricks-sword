# ============================================
# Databricks Sword — Production Docker Compose
# ============================================
# For deployment on Dokploy with Traefik reverse proxy.
#
# This is a single-service app (Next.js with API routes).
# Database is Turso (remote SQLite) — no local DB container needed.
#
# DEPLOYMENT OPTIONS:
#   Option A (Recommended): Use Dokploy UI Domains tab
#     → Remove all traefik labels below; Dokploy auto-injects them.
#     → Set domain via Dokploy UI → Domains → Add Domain.
#
#   Option B (Manual): Keep traefik labels below
#     → Replace ${DOMAIN} in labels and set it in Dokploy env.
#     → Create an A record pointing your domain to the VPS IP.

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - 3000
    environment:
      # ── Core ──
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - PORT=3000
      - HOSTNAME=0.0.0.0
      # ── Public URL ──
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
      # ── Database (Turso) ──
      - TURSO_DATABASE_URL=${TURSO_DATABASE_URL}
      - TURSO_AUTH_TOKEN=${TURSO_AUTH_TOKEN}
      # ── Auth (NextAuth v5 / Better Auth) ──
      - AUTH_URL=${AUTH_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_TRUST_HOST=${AUTH_TRUST_HOST:-true}
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
      - AUTH_GITHUB_ID=${AUTH_GITHUB_ID}
      - AUTH_GITHUB_SECRET=${AUTH_GITHUB_SECRET}
      # ── Databricks PAT Encryption ──
      - AES_ENCRYPTION_KEY=${AES_ENCRYPTION_KEY}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - dokploy-network
    labels:
      # ── Traefik routing (Manual — Option B) ──
      # Remove these labels if using Dokploy UI Domains (Option A)
      - "traefik.enable=true"
      # HTTP → HTTPS redirect
      - "traefik.http.routers.databricks-sword.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.databricks-sword.entrypoints=web"
      - "traefik.http.routers.databricks-sword.middlewares=redirect-to-https"
      # HTTPS
      - "traefik.http.routers.databricks-sword-secure.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.databricks-sword-secure.entrypoints=websecure"
      - "traefik.http.routers.databricks-sword-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.databricks-sword.loadbalancer.server.port=3000"

networks:
  dokploy-network:
    external: true
