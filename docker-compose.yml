# ============================================
# Databricks Sword â€” Docker Compose
# ============================================
# Provides local development and production environments
# using Docker containers for consistency and portability.

services:
  # ============================================
  # App Service: Next.js Application
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
      args:
        - NODE_ENV=production
        - MOCK_AUTH=${MOCK_AUTH:-}
    container_name: databricks-sword-app
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_TELEMETRY_DISABLED=1
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      - AUTH_TRUST_HOST=true
    env_file:
      - .env
    networks:
      - databricks-sword
    depends_on:
      - db
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    labels:
      - "com.databricks-sword.service=app"
      - "com.databricks-sword.environment=${NODE_ENV:-production}"

  # ============================================
  # Database Service: Turso/SQLite (local)
  # ============================================
  # For local development, we can use a SQLite file
  # In production, use Turso cloud database
  db:
    image: alpine:latest
    container_name: databricks-sword-db
    restart: unless-stopped
    volumes:
      - db-data:/data
    networks:
      - databricks-sword
    command: ["tail", "-f", "/dev/null"]
    labels:
      - "com.databricks-sword.service=database"

  # ============================================
  # Development Service (Optional)
  # ============================================
  # Hot-reload development server
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: deps
    container_name: databricks-sword-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
    command: ["pnpm", "dev"]
    networks:
      - databricks-sword
    profiles:
      - dev
    labels:
      - "com.databricks-sword.service=dev"

# ============================================
# Networks
# ============================================
networks:
  databricks-sword:
    driver: bridge
    name: databricks-sword-network

# ============================================
# Volumes
# ============================================
volumes:
  db-data:
    driver: local
    name: databricks-sword-db-data
